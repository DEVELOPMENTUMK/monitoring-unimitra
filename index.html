<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PT. UNIMITRA KHARISMA - High Capacity System</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* --- TAMPILAN TETAP SAMA --- */
#loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; display: flex; justify-content: center; align-items: center; z-index: 10000; }
.login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; width: 350px; }
.login-card h2 { margin-bottom: 20px; color: #1a73e8; }
.login-card input { width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
.login-card button { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

#profileModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10001; }
.profile-card { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; }

body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
#mainContent { display: none; max-width: 1300px; margin: auto; }

.header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.logout-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.edit-btn-small { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px; }

h1 { margin: 0; font-size: 24px; color: #2c3e50; }
.top-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
.form-box { flex: 1.2; min-width: 400px; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.chart-box { flex: 1; min-width: 350px; height: 420px; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.input-row { display: flex; gap: 15px; margin-bottom: 10px; }
.input-group { flex: 1; display: flex; flex-direction: column; }
.input-group label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; }
.input-group input, .input-group select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; }
.btn-save { background: #28a745; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 15px; font-size: 16px; }

/* Posisi Search Bar di Sebelah Kiri */
.search-container { margin-bottom: 15px; display: flex; justify-content: flex-start; }
.search-container input { padding: 10px; width: 320px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.2s; font-size: 14px; }
.search-container input:focus { border-color: #1a73e8; box-shadow: 0 0 5px rgba(26,115,232,0.2); }

table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-size: 14px; }
th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
th { background-color: #f8f9fa; color: #333; }

.btn-view { background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px; }
.btn-edit { background: #ffc107; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
.btn-hapus { background: #f8d7da; color: #721c24; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
#filePreviewList { font-size: 11px; color: #666; margin-top: 5px; }
@media print { .no-print { display: none !important; } }
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 id="authTitle">SISTEM MONITORING PT.UNIMITRA KHARISMA</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button id="mainAuthBtn" onclick="prosesLogin()">MASUK</button>
        <p id="switchAuthText" style="font-size: 12px; color: #1a73e8; cursor: pointer; margin-top: 15px;" onclick="toggleSignup()">Belum punya akun? Daftar di sini</p>
    </div>
</div>

<div id="profileModal">
    <div class="profile-card">
        <h3>Ubah Akun</h3>
        <input type="text" id="editUser" placeholder="Username Baru">
        <input type="password" id="editPass" placeholder="Password Baru">
        <button onclick="simpanPerubahanUser()" style="background:#28a745">Update</button>
        <button onclick="closeProfileModal()" style="background:#6c757d; margin-top:5px">Batal</button>
    </div>
</div>

<div id="mainContent">
    <div class="header-row no-print">
        <h1>PT. UNIMITRA KHARISMA</h1>
        <div>
            <span id="displayUser" style="font-weight:bold; margin-right:10px; color:#1a73e8"></span>
            <button class="edit-btn-small" onclick="openProfileModal()">‚öôÔ∏è Akun</button>
            <button class="logout-btn" onclick="logout()">Logout üö™</button>
        </div>
    </div>

    <div id="printArea">
        <div class="top-container">
            <div class="form-box no-print">
                <h3 style="margin-top:0">Form Input Data</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label>Model</label>
                        <input id="model" placeholder="Model">
                    </div>
                    <div class="input-group">
                        <label>CAD (Multi PDF)</label>
                        <input type="file" id="cadFiles" accept="application/pdf" multiple onchange="handleFileSelect()">
                        <div id="filePreviewList"></div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Season</label>
                        <input id="season" placeholder="Season">
                    </div>
                    <div class="input-group">
                        <label>Vendor</label>
                        <input id="vendor" placeholder="Vendor">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Tanggal</label>
                        <input type="date" id="tanggal">
                    </div>
                    <div class="input-group">
                        <label>Stage</label>
                        <select id="stage">
                            <option value="">- Pilih Stage -</option>
                            <option>Sample</option>
                            <option>Produksi</option>
                            <option>Finishing</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Keterangan</label>
                        <input id="keterangan" placeholder="Keterangan tambahan...">
                    </div>
                </div>
                <button class="btn-save" id="btnSimpan" onclick="simpanData()">Simpan Data</button>
            </div>
            <div class="chart-box">
                <canvas id="vendorChart"></canvas>
            </div>
        </div>

        <div class="search-container no-print">
            <input type="text" id="searchInput" placeholder="Cari Model, Vendor, atau Season..." onkeyup="filterData()">
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>No</th><th>Model</th><th>CAD</th><th>Season</th><th>Vendor</th><th>Tanggal</th><th>Stage</th><th>Keterangan</th><th class="no-print">Aksi</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<script>
let db;
let currentFiles = [];
let editId = null;
let vChart;
let isSignupMode = false;
let globalData = []; 

// INDEXEDDB
const request = indexedDB.open("UnimitraHighCapDB", 2);
request.onupgradeneeded = e => {
    db = e.target.result;
    if(!db.objectStoreNames.contains("vendors")) db.createObjectStore("vendors", { keyPath: "id", autoIncrement: true });
    if(!db.objectStoreNames.contains("users")) db.createObjectStore("users", { keyPath: "username" });
};
request.onsuccess = e => {
    db = e.target.result;
    if(sessionStorage.getItem("logged")) checkAuth();
};

// AUTH FUNCTIONS
function toggleSignup() {
    isSignupMode = !isSignupMode;
    document.getElementById("authTitle").innerText = isSignupMode ? "DAFTAR AKUN" : "SISTEM MONITORING";
    document.getElementById("mainAuthBtn").innerText = isSignupMode ? "DAFTAR SEKARANG" : "MASUK";
    document.getElementById("mainAuthBtn").setAttribute("onclick", isSignupMode ? "prosesSignup()" : "prosesLogin()");
    document.getElementById("switchAuthText").innerText = isSignupMode ? "Sudah punya akun? Login" : "Belum punya akun? Daftar di sini";
}

function prosesSignup() {
    const u = username.value; const p = password.value;
    if(!u || !p) return alert("Lengkapi data!");
    const tx = db.transaction("users", "readwrite");
    const store = tx.objectStore("users");
    const req = store.add({ username: u, password: p });
    req.onsuccess = () => { alert("Pendaftaran Berhasil!"); toggleSignup(); };
    req.onerror = () => alert("Username sudah digunakan!");
}

function prosesLogin() {
    const u = username.value; const p = password.value;
    if(u === "admin" && p === "123") return doLogin(u);
    db.transaction("users").objectStore("users").get(u).onsuccess = e => {
        const user = e.target.result;
        if(user && user.password === p) doLogin(u);
        else alert("Username/Password Salah!");
    };
}

function doLogin(u) {
    sessionStorage.setItem("logged", "true");
    sessionStorage.setItem("currentUser", u);
    checkAuth();
}

function checkAuth() {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("displayUser").innerText = "Halo, " + sessionStorage.getItem("currentUser");
    renderAll();
}

function logout() { sessionStorage.clear(); location.reload(); }

function openProfileModal() {
    document.getElementById("editUser").value = sessionStorage.getItem("currentUser");
    document.getElementById("profileModal").style.display = "flex";
}
function closeProfileModal() { document.getElementById("profileModal").style.display = "none"; }

function simpanPerubahanUser() {
    const oldU = sessionStorage.getItem("currentUser");
    const newU = document.getElementById("editUser").value;
    const newP = document.getElementById("editPass").value;
    if(!newU || !newP) return alert("Isi Username & Password baru!");

    const tx = db.transaction("users", "readwrite");
    const store = tx.objectStore("users");
    store.delete(oldU);
    store.put({ username: newU, password: newP }).onsuccess = () => {
        alert("Data User diupdate! Silakan login ulang.");
        logout();
    };
}

// DATA LOGIC
async function handleFileSelect() {
    const files = document.getElementById("cadFiles").files;
    currentFiles = [];
    for(let f of files) {
        const promise = new Promise(res => {
            const reader = new FileReader();
            reader.onload = e => res({ name: f.name, data: e.target.result });
            reader.readAsDataURL(f);
        });
        currentFiles.push(await promise);
    }
    document.getElementById("filePreviewList").innerText = currentFiles.length + " file dipilih";
}

async function simpanData() {
    if(!model.value || !vendor.value) return alert("Isi Model & Vendor!");
    const obj = {
        model: model.value, season: season.value, vendor: vendor.value,
        tanggal: tanggal.value, stage: stage.value, keterangan: keterangan.value,
        files: currentFiles
    };
    const tx = db.transaction("vendors", "readwrite");
    const store = tx.objectStore("vendors");
    if(editId) { obj.id = editId; store.put(obj); }
    else store.add(obj);
    tx.oncomplete = () => { 
        resetForm(); 
        document.getElementById('searchInput').value = ''; 
        renderAll(); 
        alert("Data Tersimpan!"); 
    };
}

function resetForm() {
    editId = null; currentFiles = [];
    document.querySelectorAll("input, select").forEach(i => { if(i.id !== 'searchInput') i.value = ""; });
    document.getElementById("filePreviewList").innerText = "";
    document.getElementById("cadFiles").value = "";
}

// FUNGSI PENCARIAN
function filterData() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const filtered = globalData.filter(d => 
        (d.model || "").toLowerCase().includes(keyword) || 
        (d.vendor || "").toLowerCase().includes(keyword) || 
        (d.season || "").toLowerCase().includes(keyword)
    );
    renderTable(filtered);
}

function renderAll() {
    const tx = db.transaction("vendors", "readonly");
    tx.objectStore("vendors").getAll().onsuccess = e => {
        globalData = e.target.result;
        renderTable(globalData);
        renderChart(globalData);
    };
}

function renderTable(dataToRender) {
    const tb = document.getElementById("tbody");
    tb.innerHTML = dataToRender.map((d, i) => {
        const fileBtns = (d.files || []).map((f, idx) => 
            `<button class="btn-view" onclick="openPDF(${d.id}, ${idx})">File ${idx+1}</button>`
        ).join("");
        return `<tr>
            <td>${i+1}</td><td style="font-weight:bold">${d.model}</td>
            <td>${fileBtns || "-"}</td><td>${d.season}</td><td>${d.vendor}</td>
            <td>${d.tanggal}</td><td>${d.stage}</td><td>${d.keterangan || "-"}</td>
            <td class="no-print">
                <button class="btn-edit" onclick="startEdit(${d.id})">‚úèÔ∏è</button>
                <button class="btn-hapus" onclick="hapusData(${d.id})">üóëÔ∏è</button>
            </td>
        </tr>`;
    }).join("");
}

function openPDF(id, idx) {
    db.transaction("vendors").objectStore("vendors").get(id).onsuccess = e => {
        const fileData = e.target.result.files[idx].data;
        const blob = new Blob([new Uint8Array(atob(fileData.split(',')[1]).split('').map(c=>c.charCodeAt(0)))], {type:'application/pdf'});
        window.open(URL.createObjectURL(blob), '_blank');
    };
}

function startEdit(id) {
    db.transaction("vendors").objectStore("vendors").get(id).onsuccess = e => {
        const d = e.target.result; editId = d.id;
        model.value = d.model; season.value = d.season; vendor.value = d.vendor;
        tanggal.value = d.tanggal; stage.value = d.stage; keterangan.value = d.keterangan || "";
        currentFiles = d.files || [];
        document.getElementById("filePreviewList").innerText = currentFiles.length + " file tersimpan";
        window.scrollTo({top:0, behavior:'smooth'});
    };
}

function hapusData(id) {
    if(confirm("Hapus?")) {
        const tx = db.transaction("vendors", "readwrite");
        tx.objectStore("vendors").delete(id);
        tx.oncomplete = () => renderAll();
    }
}

function renderChart(allData) {
    const cnt = {}; allData.forEach(d => cnt[d.vendor] = (cnt[d.vendor] || 0) + 1);
    const labels = Object.keys(cnt); const values = Object.values(cnt);
    const total = values.reduce((a,b)=>a+b,0);
    if(vChart) vChart.destroy();
    vChart = new Chart(document.getElementById("vendorChart"), {
        type: 'bar',
        data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>`hsl(${i*137%360},60%,50%)`) }] },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { anchor: 'end', align: 'top', formatter: v => total > 0 ? ((v/total)*100).toFixed(1)+'%' : '' }
            }
        },
        plugins: [ChartDataLabels]
    });
}
</script>
</body>
</html>
