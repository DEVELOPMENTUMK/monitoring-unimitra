<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMITRA - Cloud Monitoring</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; color: #1e293b; }
        
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #1e293b 0%, #2563eb 100%); display:flex; justify-content:center; align-items:center; z-index:2000; }
        .login-card { background: white; padding: 35px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 320px; text-align: center; }
        .login-card input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; outline:none; }
        
        #menuSelection { height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; background: #f1f5f9; }
        .menu-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .menu-card { background: white; width: 220px; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .menu-card:hover { transform: translateY(-5px); }

        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 25px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .main-container { padding: 20px; max-width: 1250px; margin: auto; }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-start; }
        .card { background: white; padding: 18px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .form-side { width: 400px; }
        .chart-side { flex: 1; min-width: 320px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        input { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 13px; }
        label { font-size: 11px; color: #64748b; font-weight: bold; margin-bottom: 2px; display: block; }

        /* Style untuk checkbox DROP */
        .drop-container { display: flex; align-items: center; gap: 10px; background: #fff1f2; padding: 10px; border-radius: 8px; border: 1px solid #fecdd3; margin-top: 10px; cursor: pointer; }
        .drop-container input { width: auto; cursor: pointer; }
        .drop-label { font-size: 13px; color: #be123c; font-weight: bold; cursor: pointer; }

        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-save { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        .btn-tool { background: white; border: 1px solid #e2e8f0; color: #475569; margin-left: 8px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; }

        .row-drop { background-color: #fff1f2 !important; color: var(--danger) !important; font-weight: bold; }
        .row-drop td { color: var(--danger) !important; }

        @media print { .header, .form-side, .btn-tool, #loginOverlay, #menuSelection, .search-input, td:last-child, th:last-child { display: none !important; } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>PT.UNIMITRA KHARISMA</h2>
        <input type="text" id="userInput" placeholder="Username">
        <input type="password" id="passInput" placeholder="Password">
        <button onclick="login()" class="btn-login">SIGN IN</button>
    </div>
</div>

<div id="menuSelection">
    <div class="menu-container">
        <div class="menu-card" onclick="bukaHalamanInput()"><h3>üìù Input Data Vendor</h3></div>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="header">
        <button onclick="kembaliKeMenu()" class="btn-tool">üè† Menu</button>
        <div id="userTag"></div>
        <button onclick="logout()" class="btn">Logout</button>
    </div>

    <div class="main-container">
        <div class="flex-row">
            <div class="card form-side">
                <h3 style="margin-top:0;">Form Data Entry</h3>
                <input type="hidden" id="editId">
                <div class="input-grid">
                    <div><label>Model</label><input type="text" id="model"></div>
                    <div><label>Desainer</label><input type="text" id="desainer"></div>
                </div>
                <div class="input-grid">
                    <div><label>Season</label><input type="text" id="season"></div>
                    <div><label>Vendor</label><input type="text" id="vendor"></div>
                </div>
                <div><label>Tanggal Kirim</label><input type="date" id="tglKirim"></div>

                <label class="drop-container">
                    <input type="checkbox" id="isDropCheck">
                    <span class="drop-label">Tandai sebagai DROP (Baris Merah)</span>
                </label>

                <button onclick="simpanData()" id="btnAction" class="btn btn-save">SIMPAN DATA</button>
            </div>

            <div class="card chart-side">
                <canvas id="vendorChart"></canvas>
            </div>
        </div>

        <div class="card">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Model</th>
                        <th>Desainer</th>
                        <th>Season</th>
                        <th>Vendor</th>
                        <th>Tgl Kirim</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-ZkAIyIRqmXf65Bh_PgjDfAVcx_l_3bo",
        authDomain: "umk-monitoring.firebaseapp.com",
        projectId: "umk-monitoring",
        storageBucket: "umk-monitoring.firebasestorage.app",
        messagingSenderId: "483335867373",
        appId: "1:483335867373:web:5d4c8d3ec97328374835e4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let chartInstance = null;

    function bukaHalamanInput() { document.getElementById("menuSelection").style.display = "none"; document.getElementById("mainContent").style.display = "block"; }
    function kembaliKeMenu() { document.getElementById("mainContent").style.display = "none"; document.getElementById("menuSelection").style.display = "flex"; }
    function login() { auth.signInWithEmailAndPassword(userInput.value + "@unimitra.com", passInput.value).catch(e => alert(e.message)); }
    function logout() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("menuSelection").style.display = "flex";
            document.getElementById("userTag").innerText = "User: " + user.email.split('@')[0];
            muatData();
        }
    });

    async function simpanData() {
        const id = document.getElementById("editId").value;
        const data = { 
            model: model.value, 
            desainer: desainer.value,
            vendor: vendor.value, 
            season: season.value, 
            tglKirim: tglKirim.value, 
            keterangan: document.getElementById("isDropCheck").checked ? "DROP" : "", // Simpan teks "DROP" jika dicentang
            waktu: firebase.firestore.FieldValue.serverTimestamp() 
        };
        if(!model.value || !vendor.value) return alert("Lengkapi data!");
        id ? await db.collection("data_unimitra").doc(id).update(data) : await db.collection("data_unimitra").add(data);
        resetForm();
    }

    function resetForm() {
        document.getElementById("editId").value = "";
        model.value = ""; desainer.value = ""; vendor.value = ""; season.value = ""; tglKirim.value = "";
        document.getElementById("isDropCheck").checked = false;
        document.getElementById("btnAction").innerText = "SIMPAN DATA";
    }

    function muatData() {
        db.collection("data_unimitra").orderBy("waktu", "desc").onSnapshot(snapshot => {
            let html = ""; let i = 1; let vendorCounts = {}; let total = 0;
            snapshot.forEach(doc => {
                let d = doc.data();
                vendorCounts[d.vendor] = (vendorCounts[d.vendor] || 0) + 1;
                total++;
                let displayDate = d.tglKirim ? d.tglKirim.split('-').reverse().join('/') : '-';
                
                let isDrop = d.keterangan === "DROP";
                let rowClass = isDrop ? "row-drop" : "";
                
                html += `<tr class="${rowClass}">
                    <td>${i++}</td>
                    <td><b>${d.model}</b></td>
                    <td>${d.desainer || '-'}</td>
                    <td>${d.season}</td>
                    <td>${d.vendor}</td>
                    <td>${displayDate}</td>
                    <td>
                        <span onclick="persiapkanEdit('${doc.id}','${d.model}','${d.desainer}','${d.vendor}','${d.season}','${d.keterangan}','${d.tglKirim}')" style="color:var(--warning); cursor:pointer;">Edit</span>
                        <span onclick="hapus('${doc.id}')" style="color:var(--danger); cursor:pointer; margin-left:10px;">Hapus</span>
                    </td>
                </tr>`;
            });
            document.getElementById("tableBody").innerHTML = html;
            renderChart(vendorCounts, total);
        });
    }

    function renderChart(data, total) {
        const ctx = document.getElementById('vendorChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{ label: '%', data: Object.values(data).map(v => ((v/total)*100).toFixed(1)), backgroundColor: '#2563eb' }]
            }
        });
    }

    function persiapkanEdit(id, m, ds, v, s, k, t) {
        document.getElementById("editId").value = id;
        model.value = m; desainer.value = ds; vendor.value = v; season.value = s; tglKirim.value = t;
        document.getElementById("isDropCheck").checked = (k === "DROP");
        document.getElementById("btnAction").innerText = "UPDATE DATA";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function hapus(id) { if(confirm("Hapus?")) db.collection("data_unimitra").doc(id).delete(); }
</script>
</body>
</html>
