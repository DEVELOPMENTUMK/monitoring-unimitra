<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMITRA - Cloud Monitoring</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; color: #1e293b; }
        
        #loginOverlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(135deg, #1e293b 0%, #2563eb 100%);
            display:flex; justify-content:center; align-items:center; z-index:2000; 
        }
        .login-card { background: white; padding: 35px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 320px; text-align: center; }
        .login-card input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; outline:none; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        #menuSelection { height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; background: #f1f5f9; }
        .menu-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .menu-card {
            background: white; width: 220px; padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;
        }
        .menu-card:hover { transform: translateY(-5px); }

        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 25px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .main-container { padding: 20px; max-width: 1250px; margin: auto; }
        .card { background: white; padding: 18px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .form-side { width: 400px; }
        .chart-side { flex: 1; min-width: 320px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        input, textarea { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 13px; }
        textarea { height: 60px; resize: none; margin-top: 8px; }
        label { font-size: 11px; color: #64748b; font-weight: bold; margin-bottom: 2px; display: block; }

        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-save { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        .btn-tool { background: white; border: 1px solid #e2e8f0; color: #475569; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; }

        .row-drop { color: var(--danger) !important; font-weight: bold; }
        
        /* Utility untuk sembunyi kolom */
        .hide-commers { display: none !important; }

        @media print {
            .header, .form-side, .btn-tool, #loginOverlay, #menuSelection, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>PT.UNIMITRA KHARISMA</h2>
        <input type="text" id="userInput" placeholder="Username">
        <input type="password" id="passInput" placeholder="Password">
        <button onclick="login()" class="btn-login">SIGN IN</button>
    </div>
</div>

<div id="menuSelection">
    <h2 style="margin-bottom: 30px;">PT.UNIMITRA KHARISMA</h2>
    <div class="menu-container">
        <div class="menu-card" onclick="bukaHalaman('vendor')">
            <div style="font-size: 50px;">üìù</div>
            <h3 style="color: var(--primary);">Input Data Vendor</h3>
        </div>
        <div class="menu-card" onclick="bukaHalaman('commers')">
            <div style="font-size: 50px;">üìä</div>
            <h3 style="color: #7c3aed;">Commers</h3>
        </div>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="header">
        <button onclick="kembaliKeMenu()" class="btn-tool">üè† Menu</button>
        <h2 id="pageTitle" style="margin:0; font-size: 18px;">PT. UNIMITRA KHARISMA</h2>
        <span id="userTag"></span>
    </div>

    <div class="main-container">
        <div class="flex-row">
            <div class="card form-side">
                <h3 style="margin:0 0 15px 0; font-size: 15px;">Form Entry (<span id="formMode"></span>)</h3>
                <input type="hidden" id="editId">
                
                <div class="input-grid">
                    <div><label>Model</label><input type="text" id="model"></div>
                    <div><label>Desainer</label><input type="text" id="desainer"></div>
                </div>
                
                <div class="input-grid commers-extra">
                    <div><label>Season</label><input type="text" id="season"></div>
                    <div id="vendorInputArea"><label>Vendor</label><input type="text" id="vendor"></div>
                </div>
                <div id="dateInputArea" class="commers-extra">
                    <label>Tanggal Kirim</label><input type="date" id="tglKirim">
                </div>

                <textarea id="keterangan" placeholder="Catatan..."></textarea>
                <button onclick="simpanData()" id="btnAction" class="btn btn-save">SIMPAN DATA</button>
            </div>

            <div class="card chart-side">
                <h3 style="text-align:center; font-size: 14px;">Statistik Data</h3>
                <canvas id="vendorChart" style="max-height: 180px;"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content: space-between;">
                <input type="text" id="searchInput" class="search-input" placeholder="Cari..." onkeyup="cariData()">
                <button onclick="downloadExcel()" class="btn btn-tool" style="color: var(--success);">Export Excel</button>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Model</th>
                        <th>Desainer</th>
                        <th class="commers-extra">Season</th>
                        <th class="commers-extra">Vendor</th>
                        <th class="commers-extra">Tgl Kirim</th>
                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-ZkAIyIRqmXf65Bh_PgjDfAVcx_l_3bo",
        authDomain: "umk-monitoring.firebaseapp.com",
        projectId: "umk-monitoring",
        storageBucket: "umk-monitoring.firebasestorage.app",
        messagingSenderId: "483335867373",
        appId: "1:483335867373:web:5d4c8d3ec97328374835e4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let chartInstance = null;
    let currentMode = 'vendor';
    let unsubscribe = null;

    function bukaHalaman(mode) {
        currentMode = mode;
        document.getElementById("menuSelection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("formMode").innerText = mode.toUpperCase();
        
        // LOGIKA SEMBUNYIKAN KOLOM UNTUK COMMERS
        const extraElements = document.querySelectorAll('.commers-extra');
        extraElements.forEach(el => {
            if(mode === 'commers') el.classList.add('hide-commers');
            else el.classList.remove('hide-commers');
        });

        resetForm();
        muatData();
    }

    function kembaliKeMenu() {
        if(unsubscribe) unsubscribe();
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("menuSelection").style.display = "flex";
    }

    function login() {
        const email = document.getElementById("userInput").value.toLowerCase() + "@unimitra.com";
        auth.signInWithEmailAndPassword(email, document.getElementById("passInput").value).catch(() => alert("Gagal Login!"));
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("menuSelection").style.display = "flex";
            document.getElementById("userTag").innerText = user.email.split('@')[0];
        }
    });

    async function simpanData() {
        const id = document.getElementById("editId").value;
        const col = currentMode === 'vendor' ? "data_unimitra" : "data_commers";
        
        const data = { 
            model: model.value, 
            desainer: desainer.value,
            keterangan: keterangan.value,
            waktu: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Hanya simpan vendor/tgl/season jika di mode Vendor
        if(currentMode === 'vendor') {
            data.vendor = vendor.value;
            data.season = season.value;
            data.tglKirim = tglKirim.value;
        }

        if(!model.value) return alert("Model wajib diisi!");
        
        id ? await db.collection(col).doc(id).update(data) : await db.collection(col).add(data);
        resetForm();
    }

    function muatData() {
        if(unsubscribe) unsubscribe();
        const col = currentMode === 'vendor' ? "data_unimitra" : "data_commers";

        unsubscribe = db.collection(col).orderBy("waktu", "desc").onSnapshot(snapshot => {
            let html = ""; let i = 1; let stats = {}; let total = 0;
            snapshot.forEach(doc => {
                let d = doc.data();
                let isDrop = d.keterangan && d.keterangan.toUpperCase().includes("DROP");
                total++;
                
                // Tentukan data untuk statistik (Model per Desainer jika Commers)
                let statKey = currentMode === 'vendor' ? d.vendor : d.desainer;
                stats[statKey] = (stats[statKey] || 0) + 1;

                html += `<tr class="${isDrop ? 'row-drop' : ''}">
                    <td>${i++}</td>
                    <td><b>${d.model}</b></td>
                    <td>${d.desainer || '-'}</td>
                    <td class="${currentMode === 'commers' ? 'hide-commers' : ''}">${d.season || '-'}</td>
                    <td class="${currentMode === 'commers' ? 'hide-commers' : ''}">${d.vendor || '-'}</td>
                    <td class="${currentMode === 'commers' ? 'hide-commers' : ''}">${d.tglKirim || '-'}</td>
                    <td class="no-print">
                        <span onclick="edit('${doc.id}',${JSON.stringify(d).replace(/"/g, '&quot;')})" style="color:var(--warning); cursor:pointer;">Edit</span> | 
                        <span onclick="hapus('${doc.id}')" style="color:var(--danger); cursor:pointer;">Hapus</span>
                    </td>
                </tr>`;
            });
            document.getElementById("tableBody").innerHTML = html;
            renderChart(stats, total);
        });
    }

    function edit(id, data) {
        document.getElementById("editId").value = id;
        model.value = data.model;
        desainer.value = data.desainer || "";
        keterangan.value = data.keterangan || "";
        if(currentMode === 'vendor') {
            vendor.value = data.vendor || "";
            season.value = data.season || "";
            tglKirim.value = data.tglKirim || "";
        }
        document.getElementById("btnAction").innerText = "UPDATE DATA";
        window.scrollTo(0,0);
    }

    function hapus(id) {
        const col = currentMode === 'vendor' ? "data_unimitra" : "data_commers";
        if(confirm("Hapus?")) db.collection(col).doc(id).delete();
    }

    function resetForm() {
        document.getElementById("editId").value = "";
        model.value = ""; desainer.value = ""; vendor.value = ""; season.value = ""; keterangan.value = ""; tglKirim.value = "";
        document.getElementById("btnAction").innerText = "SIMPAN DATA";
    }

    function renderChart(data, total) {
        const ctx = document.getElementById('vendorChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{ 
                    label: 'Jumlah Model', 
                    data: Object.values(data), 
                    backgroundColor: '#2563eb' 
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function downloadExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("dataTable"));
        XLSX.writeFile(wb, `Laporan_${currentMode}.xlsx`);
    }

    function cariData() {
        let val = searchInput.value.toLowerCase();
        let rows = tableBody.getElementsByTagName("tr");
        for (let row of rows) row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none";
    }
</script>
</body>
</html>
